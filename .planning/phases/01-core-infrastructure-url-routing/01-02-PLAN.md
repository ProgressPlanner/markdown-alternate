---
phase: 01-core-infrastructure-url-routing
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/Router/RewriteHandler.php
  - src/Plugin.php
  - markdown-alternate.php
autonomous: true

must_haves:
  truths:
    - "Visiting /any-post-slug.md returns markdown text (not 404)"
    - "Visiting /any-page-slug.md returns markdown text (not 404)"
    - "Visiting /parent/child.md returns markdown for nested pages"
    - "Visiting /post-slug.md/ redirects to /post-slug.md with 301"
    - "Draft/private/scheduled posts at .md URLs return 404"
    - "Password-protected posts at .md URLs return 403"
    - "After deactivation, .md URLs return 404"
  artifacts:
    - path: "src/Router/RewriteHandler.php"
      provides: "URL rewrite rules and markdown request handling"
      contains: "add_rewrite_rule"
      min_lines: 50
    - path: "src/Plugin.php"
      provides: "Router initialization and activation hooks"
      contains: "RewriteHandler"
  key_links:
    - from: "src/Plugin.php"
      to: "src/Router/RewriteHandler.php"
      via: "instantiation and register()"
      pattern: "RewriteHandler.*register"
    - from: "src/Router/RewriteHandler.php"
      to: "WordPress Rewrite API"
      via: "add_rewrite_rule on init hook"
      pattern: "add_rewrite_rule.*\\.md"
    - from: "src/Router/RewriteHandler.php"
      to: "template_redirect hook"
      via: "handle_markdown_request method"
      pattern: "template_redirect.*handle_markdown"
---

<objective>
Implement URL routing for .md URLs: rewrite rules capture requests, handler serves markdown content with proper status codes.

Purpose: The core functionality of Phase 1 - making /slug.md URLs work for posts and pages.
Output: Working .md URL routing with all edge cases handled (trailing slash, post status, password protection).
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-infrastructure-url-routing/01-CONTEXT.md
@.planning/phases/01-core-infrastructure-url-routing/01-RESEARCH.md
@.planning/phases/01-core-infrastructure-url-routing/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RewriteHandler with URL routing logic</name>
  <files>
    src/Router/RewriteHandler.php
  </files>
  <action>
Create src/Router/RewriteHandler.php with namespace MarkdownAlternate\Router:

**register() method:**
- Hook add_rewrite_rules() to 'init' action
- Hook add_query_vars() to 'query_vars' filter
- Hook handle_markdown_request() to 'template_redirect' action with priority 1 (early)

**add_rewrite_rules() method:**
- Use add_rewrite_rule() with pattern `(.+?)\.md$` (non-greedy for nested pages)
- Rewrite to `index.php?pagename=$matches[1]&markdown_request=1`
- Position: 'top' (highest priority)

**add_query_vars(array $vars) method:**
- Add 'markdown_request' to the query vars array
- Return modified array

**handle_markdown_request() method:**
1. Check get_query_var('markdown_request') - return early if not set
2. Enforce lowercase .md extension: check REQUEST_URI ends with `.md` (not `.MD` or `.Md`) - return to let WP 404 if wrong case
3. Handle trailing slash redirect: if REQUEST_URI ends with `.md/`, wp_redirect() to URL without trailing slash (301), exit
4. Get queried object: $post = get_queried_object()
5. Validate post exists: if not WP_Post instance, return (let WP handle 404)
6. Check post type: if not 'post' or 'page', return (let WP 404)
7. Check post status: if get_post_status($post) !== 'publish', return (let WP 404)
8. Check password protection: if post_password_required($post), return 403 with text/plain message "This content is password protected."
9. Serve markdown:
   - header('Content-Type: text/markdown; charset=UTF-8')
   - echo "# " . $post->post_title . "\n\n"
   - echo $post->post_content (raw for Phase 1, conversion in Phase 2)
   - exit

**Static register_rules() method:**
- Create instance, call add_rewrite_rules()
- Used by activation hook to register rules before flush

Code style: WordPress Coding Standards with short array syntax [], no Yoda conditions.
  </action>
  <verify>
1. PHP syntax check: `php -l src/Router/RewriteHandler.php`
2. Class exists check: `php -r "require 'vendor/autoload.php'; echo class_exists('MarkdownAlternate\Router\RewriteHandler') ? 'OK' : 'FAIL';"`
3. Verify key patterns exist in file (add_rewrite_rule, template_redirect, markdown_request)
  </verify>
  <done>
- src/Router/RewriteHandler.php exists with all methods
- Class autoloads correctly via Composer
- Contains rewrite rule pattern (.+?)\.md$
- Contains all edge case handling (trailing slash, case sensitivity, post status, password)
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire router into Plugin and activation hooks</name>
  <files>
    src/Plugin.php
    markdown-alternate.php
  </files>
  <action>
Update src/Plugin.php:

1. Add private property: $router (RewriteHandler instance)

2. In constructor, after hooks setup:
   - Instantiate RewriteHandler: $this->router = new Router\RewriteHandler()
   - Call $this->router->register() to hook into WordPress

3. Update activate() method:
   - Call Router\RewriteHandler::register_rules() to ensure rules are registered
   - Call flush_rewrite_rules() to persist rules to database

4. Update deactivate() method:
   - Call flush_rewrite_rules() to remove custom rules

5. Add use statement at top: use MarkdownAlternate\Router\RewriteHandler

Update markdown-alternate.php:

1. Update activation hook callback to call Plugin::instance()->activate() (or make activate() static)
2. Update deactivation hook callback similarly

Alternative pattern (cleaner): Move activation/deactivation hook registration to markdown-alternate.php using register_activation_hook() with callbacks that call the Plugin methods.

Ensure activation hooks are registered BEFORE Plugin::instance() since register_activation_hook must be called from main plugin file.

Code style: WordPress Coding Standards with short array syntax [], no Yoda conditions.
  </action>
  <verify>
1. PHP syntax check: `php -l src/Plugin.php` and `php -l markdown-alternate.php`
2. Verify Router instantiation: `php -r "require 'vendor/autoload.php'; \$p = MarkdownAlternate\Plugin::instance(); echo 'OK';"`
3. Check that activation hook is registered in markdown-alternate.php (grep for register_activation_hook)
  </verify>
  <done>
- Plugin.php initializes RewriteHandler on construction
- Activation hook calls register_rules() then flush_rewrite_rules()
- Deactivation hook calls flush_rewrite_rules()
- All PHP files pass syntax check
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify complete routing with integration check</name>
  <files>(no new files - verification only)</files>
  <action>
Create a verification script to test the routing logic in isolation (without full WordPress):

1. Verify file structure is complete:
   - markdown-alternate.php exists
   - composer.json exists
   - src/Plugin.php exists
   - src/Router/RewriteHandler.php exists
   - vendor/autoload.php exists
   - readme.txt exists
   - README.md exists

2. Verify Composer autoloading:
   - All classes load: Plugin, RewriteHandler

3. Verify code patterns (grep checks):
   - RewriteHandler contains: add_rewrite_rule, (.+?)\.md$, markdown_request, template_redirect, post_password_required, status_header(403)
   - Plugin contains: RewriteHandler, flush_rewrite_rules
   - markdown-alternate.php contains: register_activation_hook, register_deactivation_hook

4. Run all PHP lint checks

Output a verification report showing pass/fail for each check.
  </action>
  <verify>
All checks in the verification script pass.
  </verify>
  <done>
- All required files exist
- Autoloading works for all classes
- Critical code patterns are present
- PHP syntax is valid across all files
- Phase 1 implementation is complete and ready for WordPress testing
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify Phase 1 success criteria (from ROADMAP.md):

1. Plugin structure complete:
   ```
   markdown-alternate/
   ├── markdown-alternate.php
   ├── composer.json
   ├── readme.txt
   ├── README.md
   ├── src/
   │   ├── Plugin.php
   │   └── Router/
   │       └── RewriteHandler.php
   └── vendor/
   ```

2. Autoloading works:
   ```bash
   php -r "require 'vendor/autoload.php'; var_dump(class_exists('MarkdownAlternate\Plugin'), class_exists('MarkdownAlternate\Router\RewriteHandler'));"
   ```
   Should output: bool(true) bool(true)

3. Key functionality present (grep verification):
   - Rewrite rule: `(.+?)\.md$`
   - Query var: `markdown_request`
   - Content-Type: `text/markdown`
   - 403 for password-protected
   - Trailing slash redirect
   - Post status check

4. Activation/deactivation hooks properly wired
</verification>

<success_criteria>
- RewriteHandler.php implements complete URL routing logic
- Plugin.php wires router and handles activation/deactivation
- All edge cases handled: trailing slash, case sensitivity, post status, password protection
- Code passes PHP syntax checks
- Ready for real WordPress installation testing
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-infrastructure-url-routing/01-02-SUMMARY.md`
</output>
