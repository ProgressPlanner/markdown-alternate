---
phase: 02-content-conversion-metadata
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/Output/ContentRenderer.php
  - src/Router/RewriteHandler.php
autonomous: true

must_haves:
  truths:
    - "Markdown output includes YAML frontmatter with title, date, author"
    - "Frontmatter includes categories and tags when present"
    - "Post title appears as H1 heading after frontmatter (# Title)"
    - "Categories and tags appear at the end of the body after content"
    - "Featured image URL appears only when post has featured image"
    - "Post body HTML is converted to clean markdown"
    - "Shortcodes render (not raw [shortcode] in output)"
    - "Gutenberg blocks render (not raw <!-- wp:block --> in output)"
  artifacts:
    - path: "src/Output/ContentRenderer.php"
      provides: "Content processing and frontmatter generation"
      exports: ["ContentRenderer::render"]
      min_lines: 60
    - path: "src/Router/RewriteHandler.php"
      provides: "Updated markdown serving using ContentRenderer"
      contains: "ContentRenderer"
  key_links:
    - from: "src/Output/ContentRenderer.php"
      to: "src/Converter/MarkdownConverter.php"
      via: "use statement and instantiation"
      pattern: "new MarkdownConverter"
    - from: "src/Output/ContentRenderer.php"
      to: "apply_filters('the_content')"
      via: "WordPress content filter"
      pattern: "apply_filters.*the_content"
    - from: "src/Router/RewriteHandler.php"
      to: "src/Output/ContentRenderer.php"
      via: "use statement and instantiation"
      pattern: "new ContentRenderer"
---

<objective>
Create ContentRenderer for YAML frontmatter and content processing, then wire into RewriteHandler.

Purpose: Complete the content conversion pipeline so .md URLs return properly formatted markdown with full metadata. This is the core value of the plugin - clean, structured markdown output.

Output: ContentRenderer class, updated RewriteHandler serving complete markdown
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-content-conversion-metadata/02-RESEARCH.md
@.planning/phases/02-content-conversion-metadata/02-01-SUMMARY.md

Existing files to reference:
@src/Converter/MarkdownConverter.php
@src/Router/RewriteHandler.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ContentRenderer class</name>
  <files>src/Output/ContentRenderer.php</files>
  <action>
Create `src/Output/ContentRenderer.php`:

1. Namespace: `MarkdownAlternate\Output`
2. Use statements:
   - `use WP_Post;`
   - `use MarkdownAlternate\Converter\MarkdownConverter;`

3. Class `ContentRenderer`:

   **Private property:**
   - `MarkdownConverter $converter`

   **Constructor:**
   - Instantiate `$this->converter = new MarkdownConverter();`

   **Public method `render(WP_Post $post): string`:**
   - Call `$this->generate_frontmatter($post)` to get YAML frontmatter
   - Get title: `get_the_title($post)` for H1 heading
   - Get `$post->post_content`
   - Apply WordPress content filter: `apply_filters('the_content', $content)`
     - This renders shortcodes and Gutenberg blocks to HTML
   - Convert HTML to markdown: `$this->converter->convert($content)`
   - Call `$this->generate_footer($post)` to get categories/tags at end
   - Assemble output:
     ```
     {frontmatter}

     # {title}

     {converted body}

     {footer with categories/tags}
     ```
   - Return assembled string

   **Private method `generate_footer(WP_Post $post): string`:**
   Build footer section with categories and tags (only if present):
   - Start with `---\n\n` separator (horizontal rule in markdown)
   - Get categories: `get_the_terms($post->ID, 'category')` - if truthy and not WP_Error:
     - Format as: `**Categories:** Category One, Category Two\n`
   - Get tags: `get_the_terms($post->ID, 'post_tag')` - if truthy and not WP_Error:
     - Format as: `**Tags:** Tag One, Tag Two\n`
   - If neither categories nor tags exist, return empty string
   - Return assembled footer

   **Private method `generate_frontmatter(WP_Post $post): string`:**
   Build YAML frontmatter with `---` delimiters:
   - `title`: `get_the_title($post)` - always include, escape with `escape_yaml()`
   - `date`: `get_the_date('Y-m-d', $post)` - always include, no quotes needed
   - `author`: `get_the_author_meta('display_name', $post->post_author)` - always include, escape
   - `featured_image`: `get_the_post_thumbnail_url($post->ID, 'full')` - ONLY if truthy (returns false when not set)
   - `categories`: `get_the_terms($post->ID, 'category')` - ONLY if truthy AND not WP_Error, output as YAML array
   - `tags`: `get_the_terms($post->ID, 'post_tag')` - ONLY if truthy AND not WP_Error, output as YAML array

   For array values (categories, tags), format as:
   ```yaml
   categories:
     - "Category One"
     - "Category Two"
   ```

   **Private method `escape_yaml(string $value): string`:**
   - Escape backslashes: `\\` -> `\\\\`
   - Escape quotes: `"` -> `\"`
   - Return escaped string

Follow existing code style (short array syntax, no Yoda conditions, PHPDoc blocks).
  </action>
  <verify>
1. File exists at `src/Output/ContentRenderer.php`
2. `php -r "require 'vendor/autoload.php'; new MarkdownAlternate\Output\ContentRenderer();"` runs without error
3. Class has render() method accepting WP_Post
  </verify>
  <done>
- ContentRenderer class exists with proper namespace
- render() method generates YAML frontmatter + H1 title + converted body + footer
- Post title appears as `# Title` heading after frontmatter (CONT-01)
- Categories/tags appear at end of body as readable text (CONT-06)
- Featured image field omitted when post has no featured image
- Categories/tags also in frontmatter as YAML arrays when present (CONT-07)
- YAML values properly escaped (quotes, backslashes)
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire ContentRenderer into RewriteHandler</name>
  <files>src/Router/RewriteHandler.php</files>
  <action>
Modify `src/Router/RewriteHandler.php`:

1. Add use statement at top (after existing use statements):
   `use MarkdownAlternate\Output\ContentRenderer;`

2. In `handle_markdown_request()` method, replace the existing output section:

   OLD (around lines 107-111):
   ```php
   // Serve the markdown content
   header('Content-Type: text/markdown; charset=UTF-8');
   echo '# ' . $post->post_title . "\n\n";
   echo $post->post_content;
   exit;
   ```

   NEW:
   ```php
   // Render and serve the markdown content
   $renderer = new ContentRenderer();
   $markdown = $renderer->render($post);

   header('Content-Type: text/markdown; charset=UTF-8');
   echo $markdown;
   exit;
   ```

This replaces the raw title/content output with proper YAML frontmatter and converted markdown.
  </action>
  <verify>
1. `grep -q "ContentRenderer" src/Router/RewriteHandler.php` returns 0
2. `grep -q "generate_frontmatter\|render(" src/Router/RewriteHandler.php` returns 0 (uses ContentRenderer)
3. File no longer contains `echo '# ' . $post->post_title`
  </verify>
  <done>
- RewriteHandler imports ContentRenderer
- handle_markdown_request() uses ContentRenderer::render()
- Old raw output code removed
- .md URLs now serve complete markdown with frontmatter
  </done>
</task>

</tasks>

<verification>
These checks require a running WordPress environment. Document them for manual verification:

**Automated checks (can run without WordPress):**
```bash
# 1. Verify ContentRenderer is autoloadable
php -r "require 'vendor/autoload.php'; new MarkdownAlternate\Output\ContentRenderer();"

# 2. Verify RewriteHandler uses ContentRenderer
grep -q "use MarkdownAlternate\\\\Output\\\\ContentRenderer" src/Router/RewriteHandler.php && echo "Import OK"
grep -q "new ContentRenderer()" src/Router/RewriteHandler.php && echo "Usage OK"

# 3. Verify old output pattern removed
! grep -q "echo '# ' . \$post->post_title" src/Router/RewriteHandler.php && echo "Old code removed"
```

**Manual WordPress verification (post-deployment):**
1. Visit `/any-post-slug.md` - should return YAML frontmatter + H1 title + converted body + footer
2. Check frontmatter includes: title, date, author
3. Check `# Title` H1 heading appears immediately after frontmatter (CONT-01)
4. Post with featured image: frontmatter includes `featured_image:` field
5. Post without featured image: no `featured_image:` field in output
6. Post with categories: frontmatter includes `categories:` array AND categories appear at end after `---`
7. Post with tags: frontmatter includes `tags:` array AND tags appear at end (CONT-06)
8. Post with shortcodes: shortcodes render (no `[shortcode]` in output)
9. Gutenberg post: blocks render (no `<!-- wp:` comments in output)
</verification>

<success_criteria>
- [ ] `src/Output/ContentRenderer.php` exists with render() method
- [ ] ContentRenderer uses MarkdownConverter for HTML-to-markdown
- [ ] ContentRenderer applies `the_content` filter before conversion
- [ ] YAML frontmatter includes title, date, author (always) - CONT-07
- [ ] YAML frontmatter includes featured_image only when set
- [ ] YAML frontmatter includes categories/tags as arrays when present - CONT-07
- [ ] Post title appears as `# Title` H1 heading after frontmatter - CONT-01
- [ ] Categories/tags appear at END of body (after `---` separator) - CONT-06
- [ ] RewriteHandler uses ContentRenderer instead of raw output
- [ ] .md URLs serve complete formatted markdown
</success_criteria>

<output>
After completion, create `.planning/phases/02-content-conversion-metadata/02-02-SUMMARY.md`
</output>
